<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>圃場耕運ルート生成（安定版）</title>
<style>
body { font-family: sans-serif; }
canvas { border:1px solid #333; margin-top:10px; }
button { margin-right:5px; }
</style>
</head>
<body>

<h3>圃場耕運ルート生成（枕地3行後回し）</h3>

<input type="file" id="imgInput"><br><br>

作業幅（px換算）:
<input type="number" id="width" value="20"><br><br>

<button id="modeField">圃場指定</button>
<button id="modeIn">入口</button>
<button id="modeOut">出口</button>
<button id="closeField">圃場を閉じる</button>
<button id="gen">ルート生成</button>

<canvas id="cv"></canvas>

<script>
const canvas = document.getElementById("cv");
const ctx = canvas.getContext("2d");

let img;
let field = [];
let entry = null;
let exit = null;
let mode = "field";

document.getElementById("modeField").onclick = () => mode="field";
document.getElementById("modeIn").onclick = () => mode="in";
document.getElementById("modeOut").onclick = () => mode="out";

document.getElementById("imgInput").onchange = e => {
  img = new Image();
  img.onload = () => {
    canvas.width = img.width;
    canvas.height = img.height;
    redraw();
  };
  img.src = URL.createObjectURL(e.target.files[0]);
};

function redraw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if (img) ctx.drawImage(img,0,0);

  // 圃場
  if (field.length > 0) {
    ctx.strokeStyle="white";
    ctx.beginPath();
    field.forEach((p,i)=>i?ctx.lineTo(p[0],p[1]):ctx.moveTo(p[0],p[1]));
    if (field.length > 2) ctx.closePath();
    ctx.stroke();
  }

  // 入口出口
  if (entry) drawPoint(entry,"blue");
  if (exit) drawPoint(exit,"purple");
}

function drawPoint(p,color){
  ctx.fillStyle=color;
  ctx.beginPath();
  ctx.arc(p[0],p[1],6,0,Math.PI*2);
  ctx.fill();
}

canvas.onclick = e => {
  if (!img) return;
  const r = canvas.getBoundingClientRect();
  const x = e.clientX - r.left;
  const y = e.clientY - r.top;

  if (mode==="field") field.push([x,y]);
  if (mode==="in") entry=[x,y];
  if (mode==="out") exit=[x,y];
  redraw();
};

document.getElementById("closeField").onclick = redraw;

function pointInPoly(x,y,poly){
  let inside=false;
  for(let i=0,j=poly.length-1;i<poly.length;j=i++){
    const xi=poly[i][0], yi=poly[i][1];
    const xj=poly[j][0], yj=poly[j][1];
    const intersect=((yi>y)!==(yj>y)) &&
      (x<(xj-xi)*(y-yi)/(yj-yi)+xi);
    if(intersect) inside=!inside;
  }
  return inside;
}

document.getElementById("gen").onclick = () => {
  if (field.length<3) {
    alert("圃場を指定してください");
    return;
  }

  redraw();

  const step = Number(document.getElementById("width").value);
  const headland = step * 3;

  const ys = field.map(p=>p[1]);
  const minY = Math.min(...ys) + headland;
  const maxY = Math.max(...ys) - headland;

  ctx.strokeStyle="lime";
  ctx.lineWidth=2;
  let flip=false;

  // --- 内側耕起 ---
  for(let y=minY;y<=maxY;y+=step){
    let xs=[];
    for(let x=0;x<=canvas.width;x+=5){
      if(pointInPoly(x,y,field)) xs.push(x);
    }
    if(xs.length<2) continue;

    ctx.beginPath();
    if(!flip){
      ctx.moveTo(xs[0],y);
      ctx.lineTo(xs[xs.length-1],y);
    }else{
      ctx.moveTo(xs[xs.length-1],y);
      ctx.lineTo(xs[0],y);
    }
    ctx.stroke();
    flip=!flip;
  }

  // --- 枕地（最後に3周） ---
  ctx.strokeStyle="orange";
  for(let i=0;i<3;i++){
    const o=i*step;
    ctx.beginPath();
    field.forEach((p,j)=>{
      const px=p[0]+Math.sign(p[0]-canvas.width/2)*o;
      const py=p[1]+Math.sign(p[1]-canvas.height/2)*o;
      if(j===0) ctx.moveTo(px,py);
      else ctx.lineTo(px,py);
    });
    ctx.closePath();
    ctx.stroke();
  }
};
</script>

</body>
</html>
