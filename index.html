<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Field Route Generator (Headland Last)</title>
<style>
body { font-family: sans-serif; }
canvas {
  border: 1px solid #333;
  margin-top: 10px;
}
</style>
</head>
<body>

<h3>圃場耕運ルート生成（枕地3行後回し）</h3>

<input type="file" id="imgInput"><br><br>

作業幅（m相当）:
<input type="number" id="width" value="20"><br><br>

<button id="closeBtn">圃場を閉じる</button>
<button id="genBtn">ルート生成</button>

<canvas id="cv"></canvas>

<script>
const canvas = document.getElementById("cv");
const ctx = canvas.getContext("2d");

let img = null;
let poly = [];

document.getElementById("imgInput").onchange = e => {
  const file = e.target.files[0];
  if (!file) return;
  poly = [];

  img = new Image();
  img.onload = () => {
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img,0,0);
  };
  img.src = URL.createObjectURL(file);
};

canvas.onclick = e => {
  if (!img) return;
  const r = canvas.getBoundingClientRect();
  const x = e.clientX - r.left;
  const y = e.clientY - r.top;
  poly.push({x,y});

  ctx.fillStyle = "red";
  ctx.beginPath();
  ctx.arc(x,y,4,0,Math.PI*2);
  ctx.fill();
};

document.getElementById("closeBtn").onclick = () => {
  if (poly.length < 3) return;
  ctx.strokeStyle = "white";
  ctx.beginPath();
  poly.forEach((p,i)=>i?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y));
  ctx.closePath();
  ctx.stroke();
};

document.getElementById("genBtn").onclick = () => {
  if (poly.length < 3) return;

  const step = Number(document.getElementById("width").value);
  const headland = step * 3;

  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(img,0,0);

  // 圃場描画
  ctx.strokeStyle = "white";
  ctx.beginPath();
  poly.forEach((p,i)=>i?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y));
  ctx.closePath();
  ctx.stroke();

  // bbox
  const xs = poly.map(p=>p.x);
  const ys = poly.map(p=>p.y);
  const minX = Math.min(...xs);
  const maxX = Math.max(...xs);
  const minY = Math.min(...ys);
  const maxY = Math.max(...ys);

  // --- 内側耕起（非接続） ---
  ctx.strokeStyle = "lime";
  ctx.lineWidth = 2;
  let dir = 1;

  for (let y = minY + headland; y <= maxY - headland; y += step) {
    ctx.beginPath();
    if (dir === 1) {
      ctx.moveTo(minX + headland, y);
      ctx.lineTo(maxX - headland, y);
    } else {
      ctx.moveTo(maxX - headland, y);
      ctx.lineTo(minX + headland, y);
    }
    ctx.stroke();
    dir *= -1;
  }

  // --- 枕地（最後に3周） ---
  ctx.strokeStyle = "orange";
  for (let i=0;i<3;i++) {
    const o = i * step;
    ctx.beginPath();
    ctx.moveTo(minX+o, minY+o);
    ctx.lineTo(maxX-o, minY+o);
    ctx.lineTo(maxX-o, maxY-o);
    ctx.lineTo(minX+o, maxY-o);
    ctx.closePath();
    ctx.stroke();
  }
};
</script>

</body>
</html>
